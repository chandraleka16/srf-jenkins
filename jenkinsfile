def dockerPublisherName = "chandraleka1403"
def dockerRepoName = "php-app"
def apacheLocalImage = "apache2-image"
def mysqlLocalImage = "mysql-image"

def gitRepoName = "https://github.com/chandraleka16/srf-jenkins.git"


properties([pipelineTriggers([githubPush()])])

pipeline {
    agent {
        node {
            label 'slave2'
        }
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: "**", url: "${gitRepoName}"

                script {
                    branch = "${GIT_BRANCH}".split('/')[0]
                }
                echo "CHECK OUT BRANCH:${branch}"
            }
        }

        stage('Build') {
            steps {
                script {
                    if (branch == 'origin' || branch == 'master' || branch == 'develop'){
                        sh "sudo docker rmi ${apacheLocalImage} || true"
                        sh "sudo docker build -t ${apacheLocalImage} apache/"

                        sh "sudo docker rmi ${mysqlLocalImage} || true"
                        sh "sudo docker build -t ${mysqlLocalImage} mysql/"
                        
                    }
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    if (branch == 'master' || branch == 'develop'){
                        sh "sudo docker tag ${apacheLocalImage} ${dockerPublisherName}/${dockerRepoName}"
                        sh "sudo docker tag ${mysqlLocalImage} ${dockerPublisherName}/${dockerRepoName}"
                        sh "sudo docker push ${dockerPublisherName}/${dockerRepoName}"

                        sh "sudo docker-compose up -d"
                    } 
                }
            }
        }
    }
}
